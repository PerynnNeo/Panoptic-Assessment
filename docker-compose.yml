services:
  edge:
    build: ./edge
    container_name: edge_processor
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8g
    environment:
      - VIDEO_SOURCE=rtsp://rtsp:8554/stream?tcp
      - SAMPLER_MODE=motion
      - MOTION_THR=12.0
      - HEARTBEAT_S=2.0
      - CLOUD_URL=http://cloud:8000/ingest
      - PYTHONUNBUFFERED=1

    volumes:
      - ./results:/results
      - ./samples:/data/samples:ro
    command: ["python","/app/app.py"]

  cloud:
    build: ./cloud
    container_name: cloud_analyzer
    environment:
      - LOITER_SECONDS=10
    volumes:
      - ./results:/results
    ports:
      - "8000:8000"
    command: ["uvicorn","server:app","--host","0.0.0.0","--port","8000"]
  rtsp:
    image: bluenviron/mediamtx:latest
    container_name: rtsp_server
    ports:
      - "8554:8554"   

